name: Health Gate
on:
  pull_request: { branches: [ main, develop ] }
  workflow_dispatch: {}
permissions: { contents: read }
concurrency: { group: health-gate-${{ github.ref }}, cancel-in-progress: true }
jobs:
  verify-health-json:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: sudo apt-get update && sudo apt-get install -y jq
      - name: Validate health report (perfect only)
        run: |
          FILE="artifacts/health/report.json"
          if [ ! -f "$FILE" ]; then
            echo "::error ::Missing $FILE"; exit 1; fi
          jq -e '
            (.summary.overall_score == 10.0) and
            (.summary.pass == true) and
            ((.summary.warnings // 0) == 0) and
            ((.issues | length) == 0)
          ' "$FILE" >/dev/null || {
            echo "::error ::Health Gate failed (require 10.0, 0 issues, 0 warnings)."; exit 1; }
